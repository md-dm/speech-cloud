<script src="lib/d3/d3.js"></script>
<script src="lib/layoutcloud/d3.layout.cloud.js"></script>
<script src="lib/jquery/jquery-1.8.3.min.js"></script>

<body>
  <table>
  <tr>
  <td><div id="vis"></div></td>
  <td><div class="menu" id="menu"></div></td>
  </tr>
  </table>
<script>

  
  $.ajax( { url: "https://api.mongolab.com/api/1/databases/datafest/runCommand?apiKey=4fdcdb51e4b075eac17ca533",
          data: JSON.stringify( {"distinct": "cloud","key": "sdate","query": {}} ),
          type: "POST",
          contentType: "application/json",
          success: function(msg) {
               console.log( msg );
               var htmlStr = "";
               for(var i = 0; i < msg.values.length; i++){
                  var value = msg.values[i];
                  console.log(value);
                  htmlStr += "<a href='javascript:readData(\"" + value + "\");''>" + value + "</a><br/>";
               }
               $('div.menu')
                .html(htmlStr);
          } } )



  var fill = d3.scale.category20();
  var fontSize = d3.scale.log().range([10, 100]);
  var layout = d3.layout.cloud().size([960, 600])
        .rotate(function() { return 0; })
        .font("Impact")
        .fontSize(function(d) { 
          return fontSize(+d.size);  
        })
        .rotate(function(d) { return 0; })
        .on("end", draw);

  var svg = d3.select("#vis").append("svg")
    .attr("width", 960)
    .attr("height", 600);

  var background = svg.append("g"),
    vis = svg.append("g")
    .attr("transform", "translate(500,300)");
    

readData("20100106")

function readData(date){
  
  var url = "https://api.mongolab.com/api/1/databases/datafest/collections/cloud?q={%22sdate%22:%22" + date + "%22}&apiKey=4fdcdb51e4b075eac17ca533";

  d3.json(url, function(json) {
      data = json;
      console.log(data);
      visualizeIt(data);
    
    });

}

function visualizeIt(data){
    
    console.log("Visualize!!!");

    layout.stop().words(data[0].words).start();

  }


  function draw(words) {
  var text = vis.selectAll("text")
      .data(words, function(d) { return d.text.toLowerCase(); });
  text.transition()
      .duration(1000)
      .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
      .style("font-size", function(d) { return d.size + "px"; });
  text.enter().append("text")
      .attr("text-anchor", "middle")
      .attr("transform", function(d) { return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")"; })
      .style("font-size", function(d) { return d.size + "px"; })
      .on("click", function(d) {
        load(d.text);
      })
      .style("opacity", 1e-6)
    .transition()
      .duration(1000)
      .style("opacity", 1);
  text.style("font-family", function(d) { return d.font; })
      .style("fill", function(d) { return fill(d.text.toLowerCase()); })
      .text(function(d) { return d.text; });
  var exitGroup = background.append("g")
      .attr("transform", vis.attr("transform"));
  var exitGroupNode = exitGroup.node();
  text.exit().each(function() {
    exitGroupNode.appendChild(this);
  });
  exitGroup.transition()
      .duration(1000)
      .style("opacity", 1e-6)
      .remove();
  vis.transition()
      .delay(1000)
      .duration(750)
      .attr("transform", "translate(500,300)scale(1)");
  }
</script>